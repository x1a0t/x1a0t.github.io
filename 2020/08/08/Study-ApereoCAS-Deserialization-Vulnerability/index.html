<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>学习ApereoCAS反序列化漏洞 - x1a0t&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=JAVA>
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.02">
  
  
    <link rel="alternate" href="/atom.xml " title="x1a0t&#39;s Blog" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.2.0"></head>
  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">x1a0t&#39;s Blog</a>
    <div class="subtitle"></div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/links" class="menu-item-link">Links</a>
        </li>
      
        <li class="menu-item">
          <a href="/notes" class="menu-item-link">Notes</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">About</a>
        </li>
      
    </ul>
  </nav>
</header>
<article class="post">
  <div class="post-title">
    <h1 class="article-title">学习ApereoCAS反序列化漏洞</h1>
  </div>
   <div class="post-meta">
    <span class="post-time">2020-08-08</span>
    
      <ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/JAVA/" rel="tag">JAVA</a></li></ul>
    
  </div>
  <div class="post-content">
    <p>ApereoCAS 4.1.x ~ 4.1.6中，数据传输过程使用硬编码加解密，并在服务端进行反序列化操作，导致漏洞</p>
<p>而4.1.6以上版本的密钥为手动配置或随机生成，如果能读到tomcat启动目录下的cas日志或&#x2F;WEB-INF&#x2F;cas.properties也可拿到密钥进行反序列化，差别最多只是加密过程不同而已</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>根据web.xml找到相应的Servlet，在org.springframework.web.servlet.FrameworkServlet<br><img src="/2020/08/08/Study-ApereoCAS-Deserialization-Vulnerability/1.png"></p>
<p>跟进<code>this.processRequest(</code>，将我们的request传入到了<code>this.doService(</code>中<br><img src="/2020/08/08/Study-ApereoCAS-Deserialization-Vulnerability/2.png"></p>
<p>继续跟，在org.springframework.web.servlet.DispatcherServlet<br><img src="/2020/08/08/Study-ApereoCAS-Deserialization-Vulnerability/3.png"></p>
<p>程序对request进行了一点处理然后进入<code>this.doDispatch(</code><br><img src="/2020/08/08/Study-ApereoCAS-Deserialization-Vulnerability/4.png"></p>
<p>request进入到<code>ha.handle(</code>中，跟进org.springframework.webflow.mvc.servlet.FlowHandlerAdapter<br><img src="/2020/08/08/Study-ApereoCAS-Deserialization-Vulnerability/5.png"></p>
<p>程序从request当中获取了<code>flowExecutionKey</code>，也就是我们传入的<code>execution</code>参数，接着将其传入<code>this.flowExecutor.resumeExecution(</code>，跟进org.springframework.webflow.executor.FlowExecutorImpl<br><img src="/2020/08/08/Study-ApereoCAS-Deserialization-Vulnerability/6.png"></p>
<p><code>flowExecutionKey</code>先被传入了<code>this.executionRepository.parseFlowExecutionKe(</code>当中进行合法性的校检，满足类似<code>0-0-0-0-0_[base64]</code>即可进入到后面的<code>this.executionRepository.getFlowExecution(</code>，在org.jasig.spring.webflow.plugin.ClientFlowExecutionRepository<br><img src="/2020/08/08/Study-ApereoCAS-Deserialization-Vulnerability/7.png"></p>
<p>这里取出base64数据，然后传入<code>this.transcoder.decode(</code>，在org.jasig.spring.webflow.plugin.EncryptedTranscoder<br><img src="/2020/08/08/Study-ApereoCAS-Deserialization-Vulnerability/readObject.png"></p>
<p>可以看到数据经过解码后，最终进入了反序列化的入口。这里我们关注下解密方式<code>this.cipherBean.decrypt(</code><br><img src="/2020/08/08/Study-ApereoCAS-Deserialization-Vulnerability/8.png"><br><img src="/2020/08/08/Study-ApereoCAS-Deserialization-Vulnerability/9.png"></p>
<p>从上面代码大致可以看到加解密用的是org.cryptacular.bean.BufferedBlockCipherBean类，该类为对称加密，且这里密钥是直接硬编码的spring-webflow-client-repo-1.0.0.jar!\etc\keystore.jceks</p>
<h1 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h1><p>ApereoCAS 4.1.x ~ 4.1.6中自带有commons-collections4-4.0.jar，利用cc链构造恶意类，再利用org.jasig.spring.webflow.plugin.EncryptedTranscoder中的<code>encode(Object o)</code>加密然后base64编码下即可</p>
<p>另外<a href="http://www.00theway.org/2020/01/04/apereo-cas-rce/">这篇文章中</a>提到可利用其中的一个静态方法获取到HttpServletRequest和HttpServletResponse，用于命令回显</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExternalContext</span> <span class="variable">ec</span> <span class="operator">=</span> org.springframework.webflow.context.ExternalContextHolder.getExternalContext();</span><br><span class="line"><span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (HttpServletRequest) ec.getNativeRequest();</span><br><span class="line"><span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> (HttpServletResponse) ec.getNativeResponse();</span><br></pre></td></tr></table></figure>
<h1 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h1><p><img src="/2020/08/08/Study-ApereoCAS-Deserialization-Vulnerability/payload.png"></p>
<p>替换payload，注意进行url编码<br><img src="/2020/08/08/Study-ApereoCAS-Deserialization-Vulnerability/exploit.png"><br>Reference</p>
<p><a href="https://mvnrepository.com/artifact/org.jasig.cas/cas-server-webapp">https://mvnrepository.com/artifact/org.jasig.cas/cas-server-webapp</a><br><a href="https://www.anquanke.com/post/id/198842">https://www.anquanke.com/post/id/198842</a><br><a href="http://www.00theway.org/2020/01/04/apereo-cas-rce/">http://www.00theway.org/2020/01/04/apereo-cas-rce/</a></p>

  </div>
  <div class="post-footer">
    <a href="#top" class="top">Post.Top</a>
  </div>
</article>
<footer>
  &copy; 2024
  <span class="author">
    x1a0t
  </span>
</footer>
    </div>
  </body>
</html>